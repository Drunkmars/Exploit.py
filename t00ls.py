import sqlite3
import requests
import urllib.request
import json
from datetime import datetime
from time import sleep
import random

uname = ''  # 帐号
pswd = ''  # 密码MD5 32位(小)
qesnum =   # 安全提问 参考下面
qan = ''  # 安全提问答案
# 0 = 没有安全提问
# 1 = 母亲的名字
# 2 = 爷爷的名字
# 3 = 父亲出生的城市
# 4 = 您其中一位老师的名字
# 5 = 您个人计算机的型号
# 6 = 您最喜欢的餐馆名称
# 7 = 驾驶执照的最后四位数字

conn = sqlite3.connect('domains.db')
c = conn.cursor()

c.execute('select * from domains where used = 0')
res = c.fetchall()
length = len(res)
index = random.randint(1, length)


def randdm():
    index = random.randint(1, length)
    return res[index][1]


def tslogin(uname, pswd, qesnum, qan):
    logindata = {'action': 'login', 'username': uname, 'password': pswd, 'questionid': qesnum, 'answer': qan}
    rlogin = requests.post('https://www.t00ls.net/login.json', data=logindata)
    rlogj = json.loads(rlogin.text)

    if (rlogj["status"] != "success"):
        print("登入失败，请检查输入资料是否正确！")

    else:
        print(uname, "登入成功!")
        return rlogin


today = datetime.now()
print(today.strftime("%Y-%m-%d %H:%M:%S"))
rlogin = tslogin(uname, pswd, qesnum, qan)
if (rlogin != ""):
    rlogj = json.loads(rlogin.text)
    tscookie = requests.utils.dict_from_cookiejar(rlogin.cookies)
    tbreq = requests.get('https://www.t00ls.net/members-tubilog.json', cookies=tscookie)
    tblog = json.loads(tbreq.text)
    loglen = len(tblog["loglist"])
    allreason = ""
    for i in range(loglen):
        logday = tblog["loglist"][i]["timeline"]
        logdatetime = datetime.strptime(logday, "%Y-%m-%d %H:%M:%S")
        logdatetime = logdatetime.strftime("%Y-%m-%d")
        todaydate = today.strftime("%Y-%m-%d")
        if (logdatetime == todaydate):
            allreason += tblog["loglist"][i]["reason"]
        else:
            break
    if ("查询新com域名" in allreason):
        print("今天已经查询过域名了！")
    else:
        while True:
            try:
                domainurl = randdm()
                print('正在查询域名:', domainurl)
                querydomainsubmit = urllib.parse.quote("查询")
                postdata = {'formhash': rlogj["formhash"], 'querydomainsubmit': querydomainsubmit, 'domain': domainurl}
                rpost = requests.post('https://www.t00ls.net/domain.html', data=postdata, cookies=tscookie)
                if ("域名查询可以积累域名的信息，为进一步了解做准备，不要为了TuBi而查询。" in rpost.text):
                    c.execute("UPDATE domains set used = 1 where domain='%s'" % domainurl)
                    print("每日域名查询成功，+1 tubi！")
                    break
                elif ("Error:查询出错！域名不存在或接口有误，返回为空！" in rpost.text):
                    print("此域名:", domainurl, "不存在！")
                else:
                    c.execute("UPDATE domains set used = 1 where domain='%s'" % domainurl)
                    print("此域名:", domainurl, "已查询过！")
                sleep(1)
            except requests.exceptions.ConnectionError:
                print('请求错误，等待重试')

print('------------------------')
conn.commit()
conn.close()
